@model EPS3.ViewModels.EncumbranceRequestViewModel

@{
    ViewData["Title"] = "Contract Details";
}

<script>
   
</script>

<p>&nbsp;</p>
<div class="panel panel-default">
    <div class="panel-heading">
        <!-- Contract Information in the panel header-->
        <div class="row">
            <div class="col-sm-10">
                <h3>
                    Contract - @Html.DisplayFor(model => model.Contract.ContractNumber)
                </h3>
            </div>
            <div class="col-sm-2">
                @if(ViewBag.Roles.Contains("Admin") || ViewBag.Roles.Contains("FinanceReviewer") ||(ViewBag.Roles.Contains("Originator") && ViewBag.CurrentUser.UserID == Model.Contract.UserID))
                {
                    <a href="/Contracts/Edit/@Model.Contract.ContractID">Edit Contract</a>
                }
            </div>
        </div>
        <div class="row">
            <div class="col-sm-2">
                <dl>
                    <dt>
                        @Html.DisplayNameFor(model => model.Contract.ContractNumber)
                    </dt>
                    <dd>
                        @Html.DisplayFor(model => model.Contract.ContractNumber)
                    </dd>
                </dl>
            </div>
            <div class="col-sm-2">
                <dl>
                    <dt>
                        @Html.DisplayNameFor(model => model.Contract.ContractType)
                    </dt>
                    <dd>
                        @Html.DisplayFor(model => model.Contract.ContractType.ContractTypeSelector)
                    </dd>
                </dl>
            </div>
            <div class="col-sm-2">
                <dl>
                    <dt>
                        @Html.DisplayNameFor(model => model.Contract.IsRenewable)
                    </dt>
                    <dd>
                        @(Model.Contract.IsRenewable.ToString().Equals("0") ? "No" : "Yes")
                    </dd>
                </dl>
            </div>
            <div class="col-sm-2">
                <dl>
                    <dt>
                        @Html.DisplayNameFor(model => model.Contract.ContractTotal)
                    </dt>
                    <dd>
                        @Html.DisplayFor(model => model.Contract.ContractTotal)
                    </dd>
                </dl>
            </div>
            <div class="col-sm-2">
                <dl>
                    <dt>
                        @Html.DisplayNameFor(model => model.Contract.MaxLoaAmount)
                    </dt>
                    <dd>
                        @Html.DisplayFor(model => model.Contract.MaxLoaAmount)
                    </dd>
                </dl>
            </div>
            <div class="col-sm-2">
                <dl>
                    <dt>
                        @Html.DisplayNameFor(model => model.Contract.BudgetCeiling)
                    </dt>
                    <dd>
                        @Html.DisplayFor(model => model.Contract.BudgetCeiling)
                    </dd>
                </dl>
            </div>
        </div> <!-- close row -->
        <div class="row">
            <div class="col-sm-2">
                <dl>
                    <dt>
                        @Html.LabelFor(model => model.Contract.BeginningDate, htmlAttributes: new { @class = "control-label" })
                    </dt>
                    <dd>
                        @Html.DisplayFor(model => model.Contract.BeginningDate)
                    </dd>
                </dl>
            </div>
            <div class="col-sm-2">
                <dl>
                    <dt>
                        @Html.LabelFor(model => model.Contract.EndingDate, htmlAttributes: new { @class = "control-label" })
                    </dt>
                    <dd>
                        @Html.DisplayFor(model => model.Contract.EndingDate)
                    </dd>
                </dl>
            </div>
            <div class="col-sm-2">
                <dl>
                    <dt>
                        @Html.LabelFor(model => model.Contract.ServiceEndingDate, htmlAttributes: new { @class = "control-label" })
                    </dt>
                    <dd>
                        @Html.DisplayFor(model => model.Contract.ServiceEndingDate)
                    </dd>
                </dl>
            </div>
            <div class="col-sm-3">
                <dl>
                    <dt>
                        @Html.LabelFor(model => model.Contract.MethodOfProcurement, htmlAttributes: new { @class = "control-label" })
                    </dt>
                    <dd>
                        @Html.DisplayFor(model => model.Contract.MethodOfProcurement.ProcurementSelector)
                    </dd>
                </dl>
            </div>
            <div class="col-sm-3">
                <dl>
                    <dt>
                        @Html.LabelFor(model => model.Contract.ContractFunding, htmlAttributes: new { @class = "control-label" })
                    </dt>
                    <dd>
                        @Html.DisplayFor(model => model.Contract.ContractFunding.CompensationType)
                    </dd>
                </dl>
            </div>
            <div class="col-sm-3">
                <dl>
                    <dt>
                        @Html.LabelFor(model => model.Contract.Vendor, htmlAttributes: new { @class = "control-label" })
                    </dt>
                    <dd>
                        @Html.DisplayFor(model => model.Contract.Vendor.VendorSelector)
                    </dd>
                </dl>
            </div>
            <div class="col-sm-3">
                <dl>
                    <dt>
                        @Html.LabelFor(model => model.Contract.Recipient, htmlAttributes: new { @class = "control-label" })
                    </dt>
                    <dd>
                        @Html.DisplayFor(model => model.Contract.Recipient.RecipientSelector)
                    </dd>
                </dl>
            </div>
            <div class="col-sm-6">
                <dl>
                    <dt>
                        @Html.LabelFor(model => model.Contract.DescriptionOfWork, htmlAttributes: new { @class = "control-label" })
                    </dt>
                    <dd>
                        @Html.DisplayFor(model => model.Contract.DescriptionOfWork)
                    </dd>
                </dl>
            </div> <!-- close col -->
        </div><!-- close row -->
        <div class="row">
            <div class="col-sm-2">
                <dl>
                    <dt>
                        Amendment Amount
                    </dt>
                    <dd>
                        $@string.Format("{0:C}", ViewBag.ContractTotalAmount.ToString("#,##0.00"))
                    </dd>
                </dl>
            </div>
            <div class="col-sm-4">
                <dl>
                    <dt>
                        Contract Total Amount
                    </dt>
                    <dd>
                        $@string.Format("{0:C}", (ViewBag.ContractTotalAmount + @Model.Contract.ContractTotal).ToString("#,##0.00"))
                    </dd>
                </dl>
            </div>
            <div class="col-sm-2">
                <dl>
                    <dt>
                        Contract Status
                        <input type="hidden" id="Contract_ContractID" value="@Model.Contract.ContractID" />
                        <input type="hidden" id="Contract_UserID" value="@ViewBag.CurrentUser.UserID" />
                    </dt>
                @if (ViewBag.Roles.Contains(ConstantStrings.FinanceReviewer) || ViewBag.Roles.Contains(ConstantStrings.AdminRole))
                {
                <dd>
                    <select id="Contract_CurrentStatus" onchange="updateContractStatus()" value="@Model.Contract.CurrentStatus">
                   @foreach (SelectListItem status in ViewBag.ContractStatusSelectionList)
                    {
                        if (status.Value.Equals(Model.Contract.CurrentStatus))
                        {
                        <option selected value="@status.Value"> @status.Text </option>
                        }
                        else
                        {
                        <option value="@status.Value"> @status.Text </option>
                        }
                    }
                    </select>
                    <br />
                    <div id="UpdateSuccess"></div>
                </dd>
                }
                 else
                {
                    <dd>
                        @Model.Contract.CurrentStatus
                    </dd>
                }
                </dl>
            </div>
            <div class="col-sm-2">
                <dl>
                    <dt>
                        Contract Comments:
                    </dt>
                    <dd>
                        <textarea id="ContractStatus_Comments"></textarea>
                    </dd>
                </dl>
            </div>
        </div>
        <div class="row" id="contractHistoryHeaderDiv" name="contractHistoryHeaderDiv"> <a href="javascript: showContractHistory(@Model.Contract.ContractID)" id="showHistoryLink">Show History</a></div>
        <div class="row" id="contractHistoryDiv" name="contractHistoryDiv"></div>
    </div>
    <div class="panel-body">
        <table class="table table-striped table-bordered" id="indexTable" style="width: 100%">
            <thead>
                <tr>
                    <th colspan="10">
                        <h3>Encumbrances</h3>
                    </th>
                    <td colspan="2">
                        <a href="/LineItems/Create/?contractID=@Model.Contract.ContractID&groupID=0">Add Encumbrance Request</a>
                    </td>
                </tr>
            </thead>
            <tbody>
   @foreach (LineItemGroup group in Model.LineItemGroups)
    {
        if ((group.CurrentStatus == ConstantStrings.Draft)
            && (ViewBag.CurrentUser.UserID == group.OriginatorUserID || ViewBag.Roles.Contains(ConstantStrings.FinanceReviewer)))
        {
            <tr class="groupHeader" style="background-color: #a6dbed;" id="groupHeader_@group.GroupID">
                <td id="EncumbranceToggle_@group.GroupID">
                    <a name="enc_@group.GroupID"> </a>
                    <a href="javascript: toggleEncumbrance('@group.GroupID')" id="toggleLink_@group.GroupID">Hide encumbrance items</a>
                </td>
                <td>
                    <strong>Contract: </strong>@Model.Contract.ContractNumber <br />
                    <strong>Encumbrance: </strong>@group.GroupID <br /><br />
                    <a href="/LineItems/Create/?contractID=@Model.Contract.ContractID&groupID=@group.GroupID">Add New Line</a>
                </td>
                <td>
                    <strong>Encumbrance Type:</strong>
                    <!-- Encumbrance Request Status record-->
                    <select id="LineItemType_@group.GroupID" name="LineItemType_@group.GroupID">
               @foreach (SelectListItem itemType in ViewBag.lineItemTypes)
                {
                    if (itemType.Value.Equals(@group.LineItemType))
                    {
                        <option selected value="@itemType.Value"> @itemType.Text </option>
                    }
                    else
                    {   
                    <option value="@itemType.Value"> @itemType.Text </option>
                    }
                }
                    </select>
                </td>
                <td>
                    <strong>Status:</strong> @group.CurrentStatus <br />
                    <strong>Encumbrance Total:</strong> $@string.Format("{0:C}", ViewBag.GroupTotalAmounts[group.GroupID].ToString())
                </td>
                <td>
                    <strong>Original FLAIR Amendment ID:</strong>
                    <input type="text" id="FlairAmendmentID_@group.GroupID" value="@group.FlairAmendmentID" />
                </td>
                <td>
                    <strong>User Assigned ID:</strong>
                    <input type="text" id="UserAssignedID_@group.GroupID" value="@group.UserAssignedID" />
                </td>
                <td>
                    <strong>Corrects FLAIR Amendment ID:</strong>
                    <input type="text" id="AmendedLineItemID_@group.GroupID" value="@group.AmendedLineItemID" />
                </td>
                <td>Last Updated @String.Format("{0:d}", @group.LastEditedDate) by @group.LastEditedUser.FullName</td>
                <td colspan="2">
           @if (@group.CurrentStatus.Equals(ConstantStrings.Draft))
            {
                if (ViewBag.Roles.Contains(ConstantStrings.Originator) || ViewBag.Roles.Contains(ConstantStrings.FinanceReviewer))
                {
                    <input type="submit" class="btn btn-default" value="Save as Draft" onclick="submitEncumbrance(@group.GroupID, 'Draft')" /><br />
                    <input type="submit" class="btn btn-default" value="Submit to Finance" onclick="submitEncumbrance(@group.GroupID, 'SubmittedFinance')" />
                }
            }
           @if (@group.CurrentStatus.Equals(ConstantStrings.SubmittedFinance))
            {
                if (ViewBag.Roles.Contains(ConstantStrings.FinanceReviewer))
                {
                    <input type="submit" class="btn btn-default" value="Return to Draft" onclick="submitEncumbrance(@group.GroupID, 'Draft')" /><br />
                    <input type="submit" class="btn btn-default" value="Keep in Finance" onclick="submitEncumbrance(@group.GroupID, 'SubmittedFinance')" /><br />
                    <input type="submit" class="btn btn-default" value="Bypass Work Program" onclick="submitEncumbrance(@group.GroupID, 'CFMReady')" /><br />
                    <input type="submit" class="btn btn-default" value="Send to Work Program" onclick="submitEncumbrance(@group.GroupID, 'SubmittedWP')" />
                }
            }
           @if (@group.CurrentStatus.Equals(ConstantStrings.SubmittedWP))
            {
                if (ViewBag.Roles.Contains(ConstantStrings.WPReviewer))
                {
                    <input type="submit" class="btn btn-default" value="Return to Finance" onclick="submitEncumbrance(@group.GroupID, 'SubmittedFinance')" /><br />
                    <input type="submit" class="btn btn-default" value="Keep in Work Program" onclick="submitEncumbrance(@group.GroupID, 'SubmittedWP')" /><br />
                    <input type="submit" class="btn btn-default" value="Ready for CFM" onclick="submitEncumbrance(@group.GroupID, 'CFMReady')" />
                }
            }
           @if (@group.CurrentStatus.Equals(ConstantStrings.CFMReady))
            {
                if (ViewBag.Roles.Contains(ConstantStrings.CFMSubmitter))
                {
                    <input type="submit" class="btn btn-default" value="Return to Finance" onclick="submitEncumbrance(@group.GroupID, 'SubmittedFinance')" /><br />
                    <input type="submit" class="btn btn-default" value="Keep in CFM Ready" onclick="submitEncumbrance(@group.GroupID, 'CFMReady')" /><br />
                    <input type="submit" class="btn btn-default" value="CFM Complete" onclick="submitEncumbrance(@group.GroupID, 'CFMComplete')" />
                }
            }
                    </td>
                    <td colspan="2">
                        <strong>Comments:</strong>
                        <textarea id="Comments_@group.GroupID" name="Comments" cols="20"></textarea>
           @if (ViewBag.Roles.Contains(ConstantStrings.FinanceReviewer) && @group.CurrentStatus.Equals(ConstantStrings.SubmittedFinance))
            {
                foreach (User wpuser in ViewBag.WPReviewers)
                {
                    string thisID = "wp_" + @wpuser.UserID + "_" + @group.GroupID;
                    <input type="checkbox" id="@thisID" value="@wpuser.UserID" />@wpuser.FirstName @wpuser.LastName <br />
                }
            }
                    </td>
                </tr>

        }
        else
        {

            <tr class="groupHeader" style="background-color: #a6dbed;" id="groupHeader_@group.GroupID">
                <td id="EncumbranceToggle_@group.GroupID">
                    <a name="enc_@group.GroupID"> </a>
                @if (group.LineItems.Count > 0)
                {
                    <a href="javascript: toggleEncumbrance('@group.GroupID')" id="toggleLink_@group.GroupID">Hide encumbrance items</a>
                }
                else
                {
                    <text>There are no items in this Encumbrance Request.</text>
                }
                </td>

                <td>
                    <strong>Contract: </strong>@Model.Contract.ContractNumber <br />
                    <strong>Encumbrance: </strong>@group.GroupID <br /><br />
                    <a href="/LineItems/Create/?contractID=@Model.Contract.ContractID&groupID=@group.GroupID">Add New Line</a>
                </td>
                <td>
                    <strong>Encumbrance Type:</strong> <br /> @group.LineItemType
                </td>
                <td>
                    <strong>Status:</strong> @group.CurrentStatus  <br />
                    <strong>Encumbrance Total:</strong> $@string.Format("{0:C}", ViewBag.GroupTotalAmounts[group.GroupID].ToString("#,##0.00"))
                </td>
                <td colspan="2">
                    <strong>Original FLAIR Amendment ID:</strong>  
                    @if (String.IsNullOrEmpty(@group.FlairAmendmentID))
                            {<text>None.</text>}
                    else
                    {@group.FlairAmendmentID} <br />
                    <strong>User Assigned ID:</strong> 
                    @if (String.IsNullOrEmpty(@group.UserAssignedID))
                            {<text>None.</text>}
                    else
                    {@group.UserAssignedID}  <br />
                    <strong>Corrects FLAIR ID:</strong>  
                    @if (String.IsNullOrEmpty(@group.AmendedLineItemID))
                            {<text>None.</text>}
                    else
                    {@group.AmendedLineItemID}
                </td>
                <td colspan="2"><strong>Last Updated:</strong> <br /> @String.Format("{0:d}", @group.LastEditedDate) <br />by @group.LastEditedUser.FullName</td>
                <td colspan="2">
            @if (@group.CurrentStatus.Equals(ConstantStrings.Draft))
            {
                if (ViewBag.Roles.Contains(ConstantStrings.Originator) || ViewBag.Roles.Contains(ConstantStrings.FinanceReviewer))
                {
                    <input type="submit" class="btn btn-default" value="Save as Draft" onclick="submitEncumbrance(@group.GroupID, 'Draft')" /><br />
                    <input type="submit" class="btn btn-default" value="Submit to Finance" onclick="submitEncumbrance(@group.GroupID, 'SubmittedFinance')" />
                }
            }
            @if (@group.CurrentStatus.Equals(ConstantStrings.SubmittedFinance))
            {
                if (ViewBag.Roles.Contains(ConstantStrings.FinanceReviewer))
                {
                    <input type="submit" class="btn btn-default" value="Return to Draft" onclick="submitEncumbrance(@group.GroupID, 'Draft')" /><br />
                    <input type="submit" class="btn btn-default" value="Keep in Finance" onclick="submitEncumbrance(@group.GroupID, 'SubmittedFinance')" /><br />
                    <input type="submit" class="btn btn-default" value="Bypass Work Program" onclick="submitEncumbrance(@group.GroupID, 'CFMReady')" /><br />
                    <input type="submit" class="btn btn-default" value="Send to Work Program" onclick="submitEncumbrance(@group.GroupID, 'SubmittedWP')" />
                }
            }
            @if (@group.CurrentStatus.Equals(ConstantStrings.SubmittedWP))
             {
                if (ViewBag.Roles.Contains(ConstantStrings.WPReviewer))
                {
                    <input type="submit" class="btn btn-default" value="Return to Finance" onclick="submitEncumbrance(@group.GroupID, 'SubmittedFinance')" /><br />
                    <input type="submit" class="btn btn-default" value="Keep in Work Program" onclick="submitEncumbrance(@group.GroupID, 'SubmittedWP')" /><br />
                    <input type="submit" class="btn btn-default" value="Ready for CFM" onclick="submitEncumbrance(@group.GroupID, 'CFMReady')" />
                 }
             }
            @if (@group.CurrentStatus.Equals(ConstantStrings.CFMReady))
            {
                 if (ViewBag.Roles.Contains(ConstantStrings.CFMSubmitter))
                 {
                    <input type="submit" class="btn btn-default" value="Return to Finance" onclick="submitEncumbrance(@group.GroupID, 'SubmittedFinance')" /><br />
                    <input type="submit" class="btn btn-default" value="Keep in CFM Ready" onclick="submitEncumbrance(@group.GroupID, 'CFMReady')" /><br />
                    <input type="submit" class="btn btn-default" value="CFM Complete" onclick="submitEncumbrance(@group.GroupID, 'CFMComplete')" />
                 }
            }
                </td>
                <td colspan="2">
                    <strong>Comments:</strong>
                    <textarea id="Comments_@group.GroupID" name="Comments" cols="20"></textarea>
            @if (ViewBag.Roles.Contains(ConstantStrings.FinanceReviewer) && @group.CurrentStatus.Equals(ConstantStrings.SubmittedFinance))
            {
                 foreach (User wpuser in ViewBag.WPReviewers)
                {
                    string thisID = "wp_" + @wpuser.UserID + "_" + @group.GroupID;
                    <input type="checkbox" id="@thisID" value="@wpuser.UserID" />@wpuser.FirstName @wpuser.LastName <br />
                }
            }
                    <input type="hidden" id="LineItemType_@group.GroupID" value="@group.LineItemType" />
                    <input type="hidden" id="CurrentStatus_@group.GroupID" value="@group.CurrentStatus" />
                    <input type="hidden" id="FlairAmendmentID_@group.GroupID" value="@group.FlairAmendmentID" />
                    <input type="hidden" id="UserAssignedID_@group.GroupID" value="@group.UserAssignedID" />
                    <input type="hidden" id="AmendedLineItemID_@group.GroupID" value="@group.AmendedLineItemID" />
                    <input type="hidden" id="ContractID_@group.GroupID" value="@ViewBag.Contract.ContractID" />
                    <input type="hidden" id="ContractNumber_@group.GroupID" value="@ViewBag.Contract.ContractNumber" />
                    <input type="hidden" id="UserID_@group.GroupID" value="@ViewBag.CurrentUser.UserID" />
                    <input type="hidden" id="UserName_@group.GroupID" value="@ViewBag.CurrentUser.FullName" />
                </td>
            </tr>
           
        }
            @if (group.Statuses != null && group.Statuses.Count > 0)
            {
            <tr>
                <td colspan="13"><a href="javascript: toggleEncumbranceHistory(@group.GroupID)" id="encumbranceHistoryToggle_@group.GroupID">Show Encumbrance History</a></td>
            </tr>
            <tr class="hidden groupStatus_@group.GroupID">
                <th colspan="2">Date</th>
                <th colspan="2">Commenter</th>
                <th colspan="2">Status</th>
                <th colspan="6">Comment</th>
            </tr>
                @foreach (LineItemGroupStatus gstatus in group.Statuses)
                {
                    <tr class="hidden groupStatus_@group.GroupID">
                        <td colspan="2">@gstatus.SubmittalDate</td>
                        <td colspan="2">@gstatus.User.FullName</td>
                        <td colspan="2">@gstatus.CurrentStatus</td>
                        <td colspan="6">@gstatus.Comments</td>
                    </tr>

                }
            }

            @if (group.LineItems.Count() > 0)
            {
            <tr class="groupItem">
                <th>
                    Line Number
                </th>
                <th>
                    Organization Code
                </th>
                <th>
                    Financial Project Number
                </th>
                <th>
                    State Program
                </th>
                <th>
                    Category
                </th>
                <th>
                    Work Activity
                </th>
                <th>
                    OCA
                </th>
                <th>
                    EO
                </th>
                <th>
                    Object Code
                </th>
                <th>
                    Fund
                </th>
                <th>
                    Fiscal Year
                </th>
                <th>
                    Amount
                </th>
            </tr>
            }
            @foreach (LineItem item in group.LineItems)
            {
            <tr class="groupItem">
                <td>
                    @item.LineNumber <br />
                    <a href="/LineItems/Edit/@item.LineItemID">Edit</a> <br />
                    <a href="/LineItems/Edit/@item.LineItemID?duplicate=true">Duplicate</a>  <br />
                    <a href="/LineItems/Delete/@item.LineItemID">Delete</a>
                </td>
                <td>@item.OrgCode</td>
                <td>@item.FinancialProjectNumber</td>
                <td>@item.StateProgram.ProgramSelector</td>
                <td>@item.Category.CategorySelector</td>
                <td>@item.WorkActivity</td>
                <td>@item.OCA.OCASelector</td>
                <td>@item.ExpansionObject</td>
                <td>@item.FlairObject</td>
                <td>@item.Fund.FundSelector</td>
                <td>@item.FormattedFiscalYear()</td>
                <td>$@item.Amount.ToString("#,##0.00")</td>
            </tr>
                @if (item.Statuses != null && item.Statuses.Count > 0)
                {
                <tr>
                    <td colspan="13"><a href="javascript: toggleLineHistory(@item.LineItemID)" id="lineHistoryToggle_@item.LineItemID">Show Line Comments</a></td>
                </tr>
                <tr class="hidden lineStatus_@item.LineItemID">
                    <th colspan="2">Date</th>
                    <th colspan="2">Commenter</th>
                    <th colspan="8">Comment</th>
                </tr>
                @foreach (LineItemStatus listatus in item.Statuses)
                {
                <tr class="hidden lineStatus_@item.LineItemID">
                    <td colspan="2">@listatus.SubmittalDate</td>
                    <td colspan="2">@listatus.User.FirstName @listatus.User.LastName</td>
                    <td colspan="8">@listatus.Comments</td>
                </tr>
                 }
            }
        }

            <tr id="encumbranceHistory_@group.GroupID"></tr>
            <tr class="endOfGroup"><td colspan="13"></td></tr>
    }
            </tbody>
        </table>
    </div>
</div>